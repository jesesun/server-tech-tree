## 银行金融系统架构特点
* 高稳定性是基础
* 准确性和安全性的高要求，引入大量专业的管理平台，方便对银行各类资源的管理和监控，减少人工出错，共性是：机构管理、用户管理、角色管理、权限管理、审批流管理
* CAP中，对一致性的要求会比可用性更高
* 高扩展性（针对toB金融科技而言，客户少，必须适应客户）：SaaS/本地化、单机构/多机构、数据库适配、多接入渠道、多接出渠道
* 渠道
   * 多样性：线上线下渠道、接入接出渠道
   * 必要性：必须依赖关联方，因为没有资质
* 数据
   * 类型：原始数据包括用户、账户、交易等，加工数据包括监管、报表等。`分级，见openbanking`
   * 传输方式：http(s)、sftp（改为对象存储、分布式文件系统、区块链）
   * 高安全：对账、加密、脱敏、全操作留痕。防薅羊毛等交易防御
   * 高准确性：基于事务的一致性，TCC模型、FMT模型、XA模型
   * 应用 
      * 精准营销：个性化推荐/营销、预算管理
      * 风险管理：贷前风险预测、贷中风险监控、贷后催收管理、反欺诈
      * 数据产品：信用分、差异定价、画像产品、智能客服
      * 其他：智能投顾、量化投资
* AI   
    * 应用 
      * 智能营销
      * 智能客服
      * 智能风控
      * 智能支付
      * 智能理赔
      * 智能投顾
      * 智能投研

* 风险控制
   * 原因：风险来自于信息部队称
   * 目标：既定的损失目标下的收益最大化
   * 风控用于多种金融业务。尤其贷款，贷前——贷中——贷后，包括反欺诈、审批、合规审查、风险定价、信用评分、催收等场景
   * 征信：风控的一部分，征信的重要作用之一是为授信机构的风控活动提供信息服务
>目标：`LOSS<=目标`。`LOSS=∑ PDi * EADi * LGDi`，其中PD（Probability of Default）是违约概率、EAD（Exposure at Default）是违约风险敞口、LGD（Loss Given Default）是违约损失率，这些参数由欺诈管理、还款能力、还款意愿、还款能力和意愿的稳定性、贷后管理等数据计算所得
* 安全
   * 反欺诈、数据安全、合规监控和报告、身份认证和授权、审计、加密
* 强监管：为监管要预留设计空间
   * 管理报送：一行两会上报、外管局上报、财政部上报、本地监管部门上报
   * 面向监管部门，提供投诉通道、监视能力
   * 面向被监管机构，提供自查能力
* 金融产品交易周期长，多异步处理。可能会通过轮询查接口得到结果
* 多定时任务处理
* 多文件处理
* 新技术如何和这样的架构融合在一起？
   * 另起互联网核心
* 新技术接受度
   * 去IOE：IBM服务器被x86国产服务器代替，EMC存储被国内华为等高端存储替代，Oracle数据库被开源MySQL等数据库替代
   * 由于业务领域高要求，金融领域在新技术接受度最谨慎最慢，尤其银行it系统，代表现阶段最成熟技术。但同时看到，区块链等新技术在金融领域落地，得益于新一代金融科技公司的崛起，推动金融领域的技术更新慢慢走上快车道

## 不同企业的金融科技服务
### 传统银行组建的信科企业
* 山东省城商行合作联盟有限公司：区域性银行共享服务中心实践（2015）
   * 有非常完整的银行业务功能，向上能够对接线上（手机银行等）、线下（柜面等）、第三方（人行系统等）全渠道，向下能够对接多家金融机构。与银行传统系统在架构上差别不大，对接成本相对低
   * 技术上，对开源技术和新技术标准较保守（成本）
      * 去IOE不彻底
      * 虚拟化技术，没有容器
      * 兼容jsp，大量的xml
      * 几乎不使用新开源技术，也不对开源技术做定制化修改

![银行核心应用架构图](https://upload-images.jianshu.io/upload_images/2119886-b22f9494da7e2182.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### 金融领域IT技术服务提供商/技术外包商：壁垒较低
* 工作范围
   * 系统集成：本质上就是各种其他国内、国外的产品给客户搭搭乐高。营收涨的快，但是毛利不高。财报好看。这里面的巨无霸就是神州数码。
   * 软件开发：针对客户的需求，一个个敲代码或者开发平台搭出客户要的东西。这个是劳动力的活苦活累活。东软、中软的地盘。
   * 代理实施：拿着老外的产品，Resell&实施，或者在套一层自己的皮上去。汉得属于这一种。 

* 文思海辉：如何重塑数字化银行的核心（2015）
   * 技术紧随市场，拥抱开源技术，但限于成本和场景限制，使用的都是非常成熟的开源技术，几乎不使用新技术，也不对开源技术做定制化修改。好处是成本小，隐患是无技术壁垒、难以快速响应场景或业务的变化（新技术面向的都是可期的未来场景或业务），导致可替代性高
   * 银行核心系统的关键技术栈：服务化（研发效率）、分布式（可用性）、异步（性能）、缓存（性能）、流控（可用性）、集群（可用性）、虚拟化（资源使用效率）、海量数据处理（基于RMDB处理结构化数据，数据）、大数据处理（基于NoSQL处理非结构化数据，数据）

* 恒生电子：区块链技术催生互联网金融下一代技术（2016）

### 数据服务商
* TalkingData：移动大数据技术在互联网金融获客及经营中的应用（2015）
  ![一种数据统计系统架构](https://upload-images.jianshu.io/upload_images/2119886-71f6dca81830b589.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
   * 数据统计系统设计思想：定义了两个概念，一个是维度（一个维度是一个任意若干个字段组合），一个是度量（包括各种类SQL的计算类型：count、sum、group by等）。这样的设计十分友好，无需技术人员，产品团队就可以用来做数据统计（见图中绿色部分），他们只需配置各种数据维度并指定合适的度量计算，就能得到常用的数据统计结果（比如uv、pv等）
   * 数据营销系统（获客）设计思想：基于标签的预测，根据个人信息、交易行为、出行、购物等历史数据，为每个用户打标签，以标签集合作为特征向量训练出一套标签关联度模型，用以预测用户未来在符合某些标签时的行为

### 互联网银行
* 微众银行：基于自主可控技术的分布式架构实践（2015）    
   * 以客户为单位的可控分布（伸缩性）：一个客户的所有信息都在同一个数据节点上（这里的节点是逻辑部署单位，并非物理机器，每个节点都有备节点），设计一个GNS（全局命名服务）为每个新客户分配节点。随着客户数增加，采用scale out增加数据节点，随着交易频率上升单个客户数据增加，采用scale up增加单个节点资源
   * 基于TDSQL（数据）：腾讯自研的基于mysql的分布式数据库。
   * 安全
![信息安全体系](http://upload-images.jianshu.io/upload_images/2119886-0765423bd7475b6a.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1080/q/50)

### 中小型金融科技公司
* 点融：点融区块链即服务实践（2017）
   * BaaS（Blockchain as a Service）：介于SaaS和PaaS之间，为应用开发者屏蔽下游区块链基础设施，使区块链应用开发变得更简单
   * 迅雷、平安、阿里等互联网或金融公司也在做BaaS
* 挖财：基于大数据的信贷审批系统（2016）
* 宜信：信贷业务持续创新当中的大数据风控架构（2017）
   * 信贷风险类型：信用风险、欺诈风险、操作风险
   * 信贷业务常用系统：规则引擎/决策引擎，从开源Drools到自研谛听
   * 风险模型和规则是企业的核心资产
   * 风控的一个方面：利用AI算法（Siamese神经网络）计算工作人员日常服务中是否存在与禁言禁语相似度高的话语，以此监督工作人员与客户的沟通的合规性
* 乐信：消费金融交易系统实践（2018）
   * 消费金融特点：金融＋电商，金融：高可用、数据准确性，电商：高可用、高性能
   * 面向事件的交易应用架构（基于queue）
* [VFinance：互联网金融系统中的资金正确性保障（2014）](https://www.docin.com/p-1861701405.html)
   * 资金正确性（安全）
      * 对账（事后）：所有凭证都需入库；多层次/多频度对账；通过中间科目记录“临时状态”的资金，保证异常情况下资金追踪更加容易便捷
      * 风控（事前）：基于用户行为。风控在支付（如PayPal）和贷款场景都会用到，但策略不一样
      * 流程化上增加多人复核、跨部门复核，权限最小化原则
* [宜人贷系统架构——高并发下的进化之路](https://link.juejin.im/?target=http%3A%2F%2Fblog.dataman-inc.com%2Funtitled-10%2F%3Fhmsr%3Dtoutiao.io%26utm_medium%3Dtoutiao.io%26utm_source%3Dtoutiao.io)
   * 服务化（研发效率）：分成基础和业务两大块。基础分业务基础（用户/账户/支付等）和无业务基础（文件/配置等）。业务分成贷款和理财，两者都有自己的进件和贷后/售后基础服务，又共享撮合和债券关系两大基础服务
   * elk（Elasticsearch、Logstash、Kibana）搭建log平台(研发效率+可维护性)
   * 区分业务是强一致性还是最终一致性（数据+可用性）
      * a）强一致性业务：登录、注册、产品余额、下单、支付等。加锁防并发：数据库锁（for update等，2000/s以下）、zk分布式锁、队列或单线程使并发改串行
      * b）最终一致性：其他业务。实时性要求高的做db读写分离，加短期cache，实时性低的增大cache失效时间


### 大型金融科技公司
* [Paypal风控数据平台（2018）](https://www.wxwenku.com/d/105687973#tuit)
   * 每日2000万笔交易，10PB 数据
   * 两层用户行为实时风控模型（安全）
      * 第一层轻量决策层（50~100ms SLA）：所有用户交易行为都会过这层
      * 第二层深度决策层（200~800ms SLA）：第一层无法判断，重定向到第二层，50+模型、1w变量、1k+规则等
   * 系统设计原则
      * 数据访问抽象（研发效率）：统一api格式获取数据。130个组件抽象成3大类：写数据组件，kv数据get/put组件，高性能要求计算组件
      * 元数据驱动（数据、可用性）：配置系统，代码和数据解藕。配置格式不统一、位置不一致，用集中化配置系统管理，配置系统非单点
      * 异步非堵塞框架（性能）：基于NIO的自研框架。客户端维护一个worker group，分配多个线程向服务端发不同请求（为了充分利用CPU，建议线程数等于CPU核数），服务端有个boss group负责收集请求，然后往下分发给worker group（建议线程数等于CPU核数），worker group里分配多个工作线程执行不同请求

* 陆金所：凤凰涅槃：陆金所金融平台的架构大升级（2017）
   * 自研服务治理框架，借鉴dubbo

* [蚂蚁金服十五年技术架构演进之路(2019)](https://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&mid=2651015973&idx=1&sn=235955ae1422fb1dca168cec24938bcf&chksm=bdbeb3768ac93a608cf1f63b4336f18c084d63009876633af67ec310c37991547af7d0e7239a&scene=4&subscene=126&ascene=0&devicetype=android-27&version=2700043a&nettype=3gnet&abtest_cookie=BAABAAoACwASABMABQAjlx4AzpkeANyZHgDymR4AAJoeAAAA&lang=zh_CN&pass_ticket=p2bzwnniJfvq5BN/sy+rK5EgLCo45Yud/MBjq3RjN30+S1amHiYWc6OPFNxqguNK&wx_header=1)
   * 金融级云原生服务：解决oltp（在线交易）和olap（金融级数据智能）
   * OLTP
      * a、分布式中间件（自研sofastack）：分布式事务、微服务、分布式开发框架、服务链路分析（治理）、消息队列。数据：任何情况下最终一致性保证资金安全。伸缩性：应用级、数据库级、机房级、地域级
      * b、数据库
OceanBase自研（可用性 数据）：RTO (Recovery Time Objective，复原时间目标)<60s，RPO (Recovery Point Objective，复原点目标)=0
      * c、技术风险体系traas（可用性）：5min发现问题，5min恢复，红蓝对抗，秒级核对“账、证、实”
      * d、service mesh 化中间件
      * e、kata安全容器（安全 资源使用效率）：运行环境硬件和软件可信、数据加密
   * OLAP
      * a、数据工具和平台（数据）：自研MaxCompute数据仓库、批量（Hadoop、spark） 实时（flink、storm）
      * b、图计算（安全 数据）：反套现关系网，知识图谱
      * c、通用融合计算引擎ray（数据 安全 研发效率）：统一存储层、适配多种计算框架的引擎层（流计算 图计算 机器学习）、统一SQL数据访问层、统一研发接入的应用层。可运用到金融场景，比如花呗实时反套现检测，先流计算做特征实时计算的，一旦发现可疑账号，就切换成图计算找与这个账号有关系的账号资金处理情况

* [支付宝和蚂蚁花呗（2015）](https://www.infoq.cn/article/technical-architecture-of-alipay-and-ant-check-later)
   * LCD逻辑数据中心架构（可用性）：异地多活，蓝绿发布
   * 分布式数据架构（数据）：按业务垂直拆分（分库），按客户请求水平拆分（分表），读写分离
   * 4种分布式事务柔性服务保证数据一致性（数据+可用性）
![1.png](https://upload-images.jianshu.io/upload_images/2119886-2c275140a2cbd545.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
* [余额宝技术架构及演进（2016）](https://link.juejin.im/?target=http%3A%2F%2Fweibo.com%2Fttarticle%2Fp%2Fshow%3Fid%3D2309403997444806466244)
   * 直销和TA清算分离（可用性）：清算跑批不影响线上业务，实质上就是在线系统和离线系统的分离，有金融企业还要求银行内结算模块和银行间清算模块也分离
   * 批量清算（性能）：去IOE上云+以用户维度拆分数据，将不同维度数据分配到不同云上节点进行清算。成本400w->800w，清算时长8h->30m，并发400->5000，账户数据量1kw->2.8亿
   * 不同数据应用采用不同的存储引擎（数据）
      * 对于在线交易和批量清算，用分布式关系型数据库
      * 对于 2T 到 PB 级的小数仓可以用 PetaData，解决以年度为单位的数据存储
      * 对于大数仓/大规模批量计算，用 ODPS
      * 对大表存储，采用 OTS
      * 对于分析型、挖掘类需求，采用列存储，比如HBase等

### 大型金融机构
* 上交所：证券交易系统架构设计——挑战与实施经验分享（2014）

### 中小型互联网公司
* 唯品会：唯品金融机器学习实践（2017）

### 大型互联网公司
* 腾讯：社交数据的征信探索之路（2016）
   * 大数据应用的3大必备要素：数据、模型、平台。数据是原料，模型由存量数据训练而得，反过来对增量数据进行结果预测，平台提供数据存储和模型训练的配套工具和软硬件环境(大企业很多工具都自研)。
   * 熟人社交数据，利用关系链得到的用户画像中，学历和行业对风控和广告有显著帮助
* [淘宝交易（2014）](https://www.infoq.cn/article/2014/06/taobao-trading-system)
   * 服务治理、标准化组件（研发效率、扩展性）
   * 异步并行（性能）
   * 容灾降级、流量控制（可用性、可维护性）
* [京东交易架构分享（2016）](https://link.juejin.im/?target=http%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAwMDU1MTE1OQ%3D%3D%26mid%3D2653547431%26idx%3D1%26sn%3D744a42639e7c362a05aacbfbed6a988c%26scene%3D0%23wechat_redirect)
   * 线上压测（可用性、伸缩性）：读写分离(测试数据隔离，即打标记或另起表，真正生产用户看不到，事后删掉脏数据)，演练缩减机器，tcpcopy复制翻倍流量，模拟流量，流量泄洪(堵一会流量再放进去)
   * 性能优化（性能）：多级缓存(cdn nginx Java cache，热点->局部热点)，异步双写数据库，数据压缩传输
   * 分流限流（可用性）：多层限流nginx->Java app->DB
   * 容灾降级(机器或业务冗余)（可用性、可维护性）：网络和IDC容灾，业务降级(不到下游限流，直接在上游降级返回)
* [微信红包的架构设计简介（2015）](https://link.juejin.im/?target=https%3A%2F%2Fwww.zybuluo.com%2Fyulin718%2Fnote%2F93148)
   * 缓存（可用性+性能）：红包信息存入redis集群，一条红包一条数据，包含红包个数、剩余份额、余额等，红包剩余个数和份额可由redis单线程模型保证原子性，后台异步将redis入库
   * 跑批对账（数据）：跑批对账的方式保证最终数据一致性
* [微博付费打赏架构（2016）](https://link.juejin.im/?target=http%3A%2F%2Fchuansong.me%2Fn%2F436753151278)
   * 交易冥等性（数据）：一个订单只能保证一次支付成功，重复支付和一次支付的结果要一样。一个订单有唯一id，支付带上这个id，一旦一次成功，后续支付无法生效
   * 对账（数据）：定期用打赏和支付进行对账，保证打赏和支付数据最终一致
   * 小额免密（安全）：T+3资金监管（可能是3个交易日后到账，给予至少3天风险发现时间），每日限额，投诉通道
